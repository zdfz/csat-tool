{
  "version": 3,
  "sources": ["../../../../../Abdulrhman/CSAT TOOL/csat-app/netlify/functions/clean-data.js"],
  "sourceRoot": "C:/Users/ABDULR~1/AppData/Local/Temp/tmp-3440-TT3x02qL0bQX",
  "sourcesContent": ["const headers = {\r\n    'Access-Control-Allow-Origin': '*',\r\n    'Access-Control-Allow-Headers': 'Content-Type',\r\n    'Access-Control-Allow-Methods': 'POST, OPTIONS'\r\n};\r\n\r\nexport const handler = async (event, context) => {\r\n    if (event.httpMethod === 'OPTIONS') {\r\n        return { statusCode: 200, headers, body: '' };\r\n    }\r\n\r\n    if (event.httpMethod !== 'POST') {\r\n        return { statusCode: 405, headers, body: JSON.stringify({ error: 'Method Not Allowed' }) };\r\n    }\r\n\r\n    try {\r\n        const body = JSON.parse(event.body);\r\n        const { data, action, params } = body;\r\n\r\n        if (!Array.isArray(data)) {\r\n            return {\r\n                statusCode: 400,\r\n                headers,\r\n                body: JSON.stringify({ error: 'Invalid input: data must be an array' })\r\n            };\r\n        }\r\n\r\n        let processedData = [...data];\r\n        let stats = {\r\n            initialRows: data.length,\r\n            finalRows: 0,\r\n            removed: 0\r\n        };\r\n\r\n        if (action === 'clean') {\r\n            // Trim strings, normalize spaces, drop empty\r\n            processedData = processedData.filter(row => {\r\n                // Drop empty rows (check if all values are empty)\r\n                const values = Object.values(row);\r\n                const isEmpty = values.every(v => v === null || v === undefined || v === '');\r\n                return !isEmpty;\r\n            }).map(row => {\r\n                const newRow = {};\r\n                Object.keys(row).forEach(key => {\r\n                    const val = row[key];\r\n                    if (typeof val === 'string') {\r\n                        newRow[key] = val.trim().replace(/\\s+/g, ' ');\r\n                    } else {\r\n                        newRow[key] = val;\r\n                    }\r\n                });\r\n                return newRow;\r\n            });\r\n        }\r\n\r\n        else if (action === 'filter') {\r\n            // Date Margin Filter\r\n            const { deliveryCol, submittedCol, marginDays = 1 } = params || {};\r\n            const margin = parseInt(marginDays);\r\n\r\n            processedData = processedData.filter(row => {\r\n                const delivery = row[deliveryCol] ? new Date(row[deliveryCol]) : null;\r\n                const submitted = row[submittedCol] ? new Date(row[submittedCol]) : null;\r\n\r\n                if (!delivery || isNaN(delivery) || !submitted || isNaN(submitted)) return false;\r\n\r\n                // Simple day diff\r\n                const diffTime = Math.abs(delivery - submitted);\r\n                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));\r\n\r\n                return diffDays <= margin;\r\n            });\r\n        }\r\n\r\n        else if (action === 'dedup') {\r\n            const { trackingCol, keep = 'last' } = params || {};\r\n            if (!trackingCol) {\r\n                return { statusCode: 400, headers, body: JSON.stringify({ error: 'trackingCol required for dedup' }) };\r\n            }\r\n\r\n            // Group by tracking col\r\n            const groups = new Map();\r\n            processedData.forEach(row => {\r\n                const key = row[trackingCol];\r\n                if (!key) return; // Skip missing keys\r\n                if (!groups.has(key)) groups.set(key, []);\r\n                groups.get(key).push(row);\r\n            });\r\n\r\n            processedData = [];\r\n            groups.forEach((rows) => {\r\n                if (keep === 'first') {\r\n                    processedData.push(rows[0]);\r\n                } else if (keep === 'last') {\r\n                    processedData.push(rows[rows.length - 1]); // Assuming input order matters\r\n                } else if (keep === 'random') {\r\n                    const idx = Math.floor(Math.random() * rows.length);\r\n                    processedData.push(rows[idx]);\r\n                } else {\r\n                    processedData.push(rows[rows.length - 1]);\r\n                }\r\n            });\r\n        }\r\n\r\n        stats.finalRows = processedData.length;\r\n        stats.removed = stats.initialRows - stats.finalRows;\r\n\r\n        return {\r\n            statusCode: 200,\r\n            headers,\r\n            body: JSON.stringify({\r\n                results: processedData,\r\n                stats\r\n            })\r\n        };\r\n\r\n    } catch (error) {\r\n        console.error('Function error:', error);\r\n        return {\r\n            statusCode: 500,\r\n            headers,\r\n            body: JSON.stringify({ error: 'Internal Server Error', details: error.message })\r\n        };\r\n    }\r\n};\r\n"],
  "mappings": "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",
  "names": []
}
