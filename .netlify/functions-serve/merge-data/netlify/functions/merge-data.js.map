{
  "version": 3,
  "sources": ["../../../../../Abdulrhman/CSAT TOOL/csat-app/netlify/functions/merge-data.js"],
  "sourceRoot": "C:/Users/ABDULR~1/AppData/Local/Temp/tmp-3440-VXk9gxH7jKvD",
  "sourcesContent": ["const headers = {\r\n    'Access-Control-Allow-Origin': '*',\r\n    'Access-Control-Allow-Headers': 'Content-Type',\r\n    'Access-Control-Allow-Methods': 'POST, OPTIONS'\r\n};\r\n\r\nexport const handler = async (event, context) => {\r\n    if (event.httpMethod === 'OPTIONS') {\r\n        return { statusCode: 200, headers, body: '' };\r\n    }\r\n\r\n    if (event.httpMethod !== 'POST') {\r\n        return { statusCode: 405, headers, body: JSON.stringify({ error: 'Method Not Allowed' }) };\r\n    }\r\n\r\n    try {\r\n        const body = JSON.parse(event.body);\r\n        const { mainData, secondaryData, mainMobileCol, secondaryMobileCol } = body;\r\n\r\n        if (!Array.isArray(mainData) || !Array.isArray(secondaryData)) {\r\n            return {\r\n                statusCode: 400,\r\n                headers,\r\n                body: JSON.stringify({ error: 'Invalid input: mainData and secondaryData must be arrays' })\r\n            };\r\n        }\r\n\r\n        // Helper to find mobile col if not provided\r\n        const findMobileCol = (row) => {\r\n            const aliases = ['mobile', 'consignee phone', 'phone', 'contact number', 'tel', 'consignee_phone'];\r\n            const keys = Object.keys(row);\r\n            return keys.find(k => aliases.includes(k.toLowerCase())) || keys.find(k => k.toLowerCase().includes('mobile'));\r\n        };\r\n\r\n        const effectiveMainCol = mainMobileCol || findMobileCol(mainData[0] || {});\r\n        const effectiveSecCol = secondaryMobileCol || findMobileCol(secondaryData[0] || {});\r\n\r\n        if (!effectiveMainCol) {\r\n            return { statusCode: 400, headers, body: JSON.stringify({ error: 'Could not detect mobile column in main file' }) };\r\n        }\r\n\r\n        // Clean mobile function\r\n        // Create robust normalization key for comparison\r\n        const normalizeMobile = (val) => {\r\n            if (!val) return '';\r\n\r\n            // 1. Convert to string, lowercase, trim\r\n            let s = String(val).toLowerCase().trim();\r\n\r\n            // 2. Remove floating point .0 if present (excel artifact)\r\n            if (s.endsWith('.0')) s = s.slice(0, -2);\r\n\r\n            // 3. Remove all non-digit characters\r\n            s = s.replace(/\\D/g, '');\r\n\r\n            // 4. Standardize Saudi format (assuming 9 digit core)\r\n            // If starts with 05... (10 digits) -> 9665...\r\n            if (s.startsWith('05') && s.length === 10) {\r\n                return '966' + s.substring(1);\r\n            }\r\n            // If starts with 5... (9 digits) -> 9665...\r\n            if (s.startsWith('5') && s.length === 9) {\r\n                return '966' + s;\r\n            }\r\n            // If starts with 966... -> keep as is\r\n\r\n            return s;\r\n        };\r\n\r\n        // Helper to get value case-insensitively if needed\r\n        const getValue = (row, colName) => {\r\n            if (row[colName] !== undefined) return row[colName];\r\n            // Fallback: search keys case-insensitive\r\n            const key = Object.keys(row).find(k => k.toLowerCase() === colName.toLowerCase());\r\n            return key ? row[key] : undefined;\r\n        };\r\n\r\n        const secondaryMap = new Map();\r\n        secondaryData.forEach(row => {\r\n            const rawVal = getValue(row, effectiveSecCol);\r\n            if (!rawVal) return;\r\n            const key = normalizeMobile(rawVal);\r\n            if (!secondaryMap.has(key)) {\r\n                secondaryMap.set(key, []);\r\n            }\r\n            secondaryMap.get(key).push(row);\r\n        });\r\n\r\n        const results = [];\r\n        let actualMatchCount = 0;\r\n\r\n        // Debug collection\r\n        const debugInfo = {\r\n            sampleMainKeys: [],\r\n            sampleSecKeys: Array.from(secondaryMap.keys()).slice(0, 5),\r\n            secMapSize: secondaryMap.size,\r\n            unmatchedSamples: []\r\n        };\r\n\r\n        mainData.forEach((mainRow, idx) => {\r\n            const rawVal = getValue(mainRow, effectiveMainCol);\r\n            const key = normalizeMobile(rawVal);\r\n\r\n            if (idx < 5) debugInfo.sampleMainKeys.push({ raw: rawVal, normalized: key });\r\n\r\n            const matches = secondaryMap.get(key);\r\n\r\n            if (matches && matches.length > 0) {\r\n                actualMatchCount += matches.length;\r\n                // Cartesian product\r\n                matches.forEach(match => {\r\n                    const merged = { ...mainRow };\r\n                    Object.keys(match).forEach(k => {\r\n                        if (k === effectiveSecCol) return; // Skip key column from secondary\r\n                        if (k in merged) {\r\n                            merged[`${k}_secondary`] = match[k];\r\n                        } else {\r\n                            merged[k] = match[k];\r\n                        }\r\n                    });\r\n                    results.push(merged);\r\n                });\r\n            } else {\r\n                // No match, keep main row\r\n                if (debugInfo.unmatchedSamples.length < 5) debugInfo.unmatchedSamples.push(key);\r\n                results.push(mainRow);\r\n            }\r\n        });\r\n\r\n        return {\r\n            statusCode: 200,\r\n            headers,\r\n            body: JSON.stringify({\r\n                results,\r\n                meta: {\r\n                    mainRows: mainData.length,\r\n                    secondaryRows: secondaryData.length,\r\n                    mergedRows: results.length,\r\n                    matchCount: actualMatchCount,\r\n                    debug: debugInfo\r\n                }\r\n            })\r\n        };\r\n\r\n    } catch (error) {\r\n        console.error('Function error:', error);\r\n        return {\r\n            statusCode: 500,\r\n            headers,\r\n            body: JSON.stringify({ error: 'Internal Server Error', details: error.message })\r\n        };\r\n    }\r\n};\r\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,IAAM,UAAU;AAAA,EACZ,+BAA+B;AAAA,EAC/B,gCAAgC;AAAA,EAChC,gCAAgC;AACpC;AAEO,IAAM,UAAU,OAAO,OAAO,YAAY;AAC7C,MAAI,MAAM,eAAe,WAAW;AAChC,WAAO,EAAE,YAAY,KAAK,SAAS,MAAM,GAAG;AAAA,EAChD;AAEA,MAAI,MAAM,eAAe,QAAQ;AAC7B,WAAO,EAAE,YAAY,KAAK,SAAS,MAAM,KAAK,UAAU,EAAE,OAAO,qBAAqB,CAAC,EAAE;AAAA,EAC7F;AAEA,MAAI;AACA,UAAM,OAAO,KAAK,MAAM,MAAM,IAAI;AAClC,UAAM,EAAE,UAAU,eAAe,eAAe,mBAAmB,IAAI;AAEvE,QAAI,CAAC,MAAM,QAAQ,QAAQ,KAAK,CAAC,MAAM,QAAQ,aAAa,GAAG;AAC3D,aAAO;AAAA,QACH,YAAY;AAAA,QACZ;AAAA,QACA,MAAM,KAAK,UAAU,EAAE,OAAO,2DAA2D,CAAC;AAAA,MAC9F;AAAA,IACJ;AAGA,UAAM,gBAAgB,CAAC,QAAQ;AAC3B,YAAM,UAAU,CAAC,UAAU,mBAAmB,SAAS,kBAAkB,OAAO,iBAAiB;AACjG,YAAM,OAAO,OAAO,KAAK,GAAG;AAC5B,aAAO,KAAK,KAAK,OAAK,QAAQ,SAAS,EAAE,YAAY,CAAC,CAAC,KAAK,KAAK,KAAK,OAAK,EAAE,YAAY,EAAE,SAAS,QAAQ,CAAC;AAAA,IACjH;AAEA,UAAM,mBAAmB,iBAAiB,cAAc,SAAS,CAAC,KAAK,CAAC,CAAC;AACzE,UAAM,kBAAkB,sBAAsB,cAAc,cAAc,CAAC,KAAK,CAAC,CAAC;AAElF,QAAI,CAAC,kBAAkB;AACnB,aAAO,EAAE,YAAY,KAAK,SAAS,MAAM,KAAK,UAAU,EAAE,OAAO,8CAA8C,CAAC,EAAE;AAAA,IACtH;AAIA,UAAM,kBAAkB,CAAC,QAAQ;AAC7B,UAAI,CAAC,IAAK,QAAO;AAGjB,UAAI,IAAI,OAAO,GAAG,EAAE,YAAY,EAAE,KAAK;AAGvC,UAAI,EAAE,SAAS,IAAI,EAAG,KAAI,EAAE,MAAM,GAAG,EAAE;AAGvC,UAAI,EAAE,QAAQ,OAAO,EAAE;AAIvB,UAAI,EAAE,WAAW,IAAI,KAAK,EAAE,WAAW,IAAI;AACvC,eAAO,QAAQ,EAAE,UAAU,CAAC;AAAA,MAChC;AAEA,UAAI,EAAE,WAAW,GAAG,KAAK,EAAE,WAAW,GAAG;AACrC,eAAO,QAAQ;AAAA,MACnB;AAGA,aAAO;AAAA,IACX;AAGA,UAAM,WAAW,CAAC,KAAK,YAAY;AAC/B,UAAI,IAAI,OAAO,MAAM,OAAW,QAAO,IAAI,OAAO;AAElD,YAAM,MAAM,OAAO,KAAK,GAAG,EAAE,KAAK,OAAK,EAAE,YAAY,MAAM,QAAQ,YAAY,CAAC;AAChF,aAAO,MAAM,IAAI,GAAG,IAAI;AAAA,IAC5B;AAEA,UAAM,eAAe,oBAAI,IAAI;AAC7B,kBAAc,QAAQ,SAAO;AACzB,YAAM,SAAS,SAAS,KAAK,eAAe;AAC5C,UAAI,CAAC,OAAQ;AACb,YAAM,MAAM,gBAAgB,MAAM;AAClC,UAAI,CAAC,aAAa,IAAI,GAAG,GAAG;AACxB,qBAAa,IAAI,KAAK,CAAC,CAAC;AAAA,MAC5B;AACA,mBAAa,IAAI,GAAG,EAAE,KAAK,GAAG;AAAA,IAClC,CAAC;AAED,UAAM,UAAU,CAAC;AACjB,QAAI,mBAAmB;AAGvB,UAAM,YAAY;AAAA,MACd,gBAAgB,CAAC;AAAA,MACjB,eAAe,MAAM,KAAK,aAAa,KAAK,CAAC,EAAE,MAAM,GAAG,CAAC;AAAA,MACzD,YAAY,aAAa;AAAA,MACzB,kBAAkB,CAAC;AAAA,IACvB;AAEA,aAAS,QAAQ,CAAC,SAAS,QAAQ;AAC/B,YAAM,SAAS,SAAS,SAAS,gBAAgB;AACjD,YAAM,MAAM,gBAAgB,MAAM;AAElC,UAAI,MAAM,EAAG,WAAU,eAAe,KAAK,EAAE,KAAK,QAAQ,YAAY,IAAI,CAAC;AAE3E,YAAM,UAAU,aAAa,IAAI,GAAG;AAEpC,UAAI,WAAW,QAAQ,SAAS,GAAG;AAC/B,4BAAoB,QAAQ;AAE5B,gBAAQ,QAAQ,WAAS;AACrB,gBAAM,SAAS,EAAE,GAAG,QAAQ;AAC5B,iBAAO,KAAK,KAAK,EAAE,QAAQ,OAAK;AAC5B,gBAAI,MAAM,gBAAiB;AAC3B,gBAAI,KAAK,QAAQ;AACb,qBAAO,GAAG,CAAC,YAAY,IAAI,MAAM,CAAC;AAAA,YACtC,OAAO;AACH,qBAAO,CAAC,IAAI,MAAM,CAAC;AAAA,YACvB;AAAA,UACJ,CAAC;AACD,kBAAQ,KAAK,MAAM;AAAA,QACvB,CAAC;AAAA,MACL,OAAO;AAEH,YAAI,UAAU,iBAAiB,SAAS,EAAG,WAAU,iBAAiB,KAAK,GAAG;AAC9E,gBAAQ,KAAK,OAAO;AAAA,MACxB;AAAA,IACJ,CAAC;AAED,WAAO;AAAA,MACH,YAAY;AAAA,MACZ;AAAA,MACA,MAAM,KAAK,UAAU;AAAA,QACjB;AAAA,QACA,MAAM;AAAA,UACF,UAAU,SAAS;AAAA,UACnB,eAAe,cAAc;AAAA,UAC7B,YAAY,QAAQ;AAAA,UACpB,YAAY;AAAA,UACZ,OAAO;AAAA,QACX;AAAA,MACJ,CAAC;AAAA,IACL;AAAA,EAEJ,SAAS,OAAO;AACZ,YAAQ,MAAM,mBAAmB,KAAK;AACtC,WAAO;AAAA,MACH,YAAY;AAAA,MACZ;AAAA,MACA,MAAM,KAAK,UAAU,EAAE,OAAO,yBAAyB,SAAS,MAAM,QAAQ,CAAC;AAAA,IACnF;AAAA,EACJ;AACJ;",
  "names": []
}
